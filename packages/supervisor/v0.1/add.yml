---
- name: Ensure Supervisor is installed
  apt:
    name=supervisor
    state=present

- include: DEVOPS_PACKAGE/tasks/enable.yml

- name: Prepare Supervisor default configuration
  template:
    src=DEVOPS_PACKAGE/templates/supervisord.conf.j2
    dest=/etc/supervisor/conf.d/supervisord.conf
    owner=root
    group=root
    mode=0644
  notify: Restart Supervisor

- name: Prepare configurations for the Supervisor's programs
  template:
    src=DEVOPS_PACKAGE/templates/program.conf.j2
    dest=/etc/supervisor/conf.d/{{ item.name }}.conf
    owner=root
    group=root
    mode=0644
  with_items:
    supervisor.programs | default([])
  register:
    supervisor_programs

- name: Restart Supervisor's programs if needed
  supervisorctl:
    name={{ item.item.name }}
    state=restarted
  when:
    item.changed
  with_items:
    supervisor_programs

- include: DEVOPS_PACKAGE/tasks/start.yml
