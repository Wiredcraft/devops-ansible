---
- name: Ensure mysql-client is installed
  apt: pkg=mysql-client state=present

- name: Ensure mysql-server is installed
  apt: pkg=mysql-server state=present

- name: Ensure python-mysqldb is installed
  apt: pkg=python-mysqldb state=present

# Ensure config
- name: Ensure mysql-server configuration
  template:
    src=DEVOPS_PACKAGE/templates/my.cnf.j2
    dest=/etc/mysql/my.cnf
    owner=root
    mode=0640
  notify: Restart MySQL

# Ensure running
- include: DEVOPS_PACKAGE/tasks/start.yml

- name: Prepare mysql password
  shell:
    if [ -f mysql_root.passwd ]; then cat mysql_root.passwd; else cat /dev/urandom | base64 | head -c20 | tee mysql_root.passwd ; fi
  register:
    mysql_root_pass

- name: Set up root pass for mysql (localhost)
  mysql_user: 
    name=root
    password={{ mysql_root_pass.stdout }}
    state=present
    host={{ item }}
  with_items:
    - localhost
- name: Prepare root .my.cnf
  template:
    src=DEVOPS_PACKAGE/templates/client.my.cnf.j2
    dest=/root/.my.cnf
    owner=root
    group=root
    mode=0600
- name: Set up root pass for mysql (other localhost aliases)
  mysql_user: 
    name=root
    password={{ mysql_root_pass.stdout }}
    state=present
    host={{ item }}
  with_items:
    - localhost
    - 127.0.0.1
    - ::1
    - "{{ ansible_hostname }}"

# Handle users and databases
- include: DEVOPS_PACKAGE/tasks/users.yml
- include: DEVOPS_PACKAGE/tasks/databases.yml




# - name: Ensure MySQL root password
#   mysql_user: 
#     name=root
#     password=mysql_root_pass.stdout
#     priv=*.*:ALL,GRANT
#     state=present

# - name: Ensure the root user can log on MySQL
#   template:
#     src=DEVOPS_PACKAGE/templates/client.my.cnf.j2
#     dest=/root/.my.cnf
#     owner=root
#     mode=0400
  # with_password: 
  #   DEVOPS_BASE/users/{{ user }}/{{ inventory_hostname }}/mysql_root_password
  #   length=20
