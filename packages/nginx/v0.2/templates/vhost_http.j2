{% set php = php | default({}) %}
{% set fpm = php.fpm | default({}) %}
{% set pool = fpm.pool | default({}) %}
{% set nginx_vhost_php = task.nginx.add_http_vhost.php | default('off') %}
{% set nginx = nginx | default({}) %}
{% set http = nginx.http | default({}) %}

server {
    listen   {{ task.nginx.add_http_vhost.port }};

    root /var/www/{{ task.nginx.add_http_vhost.domain }}/{{ task.nginx.add_http_vhost.webroot }};
    index {% if nginx_vhost_php == 'on' %}index.php{% endif %} index.html index.htm;

    access_log {{ http.access_log | dirname }}/{{ task.nginx.add_http_vhost.domain }}-access.log;
    error_log {{ http.error_log | dirname }}/{{ task.nginx.add_http_vhost.domain }}-error.log;

    # Make site accessible from http://localhost/
    # server_name {{ task.nginx.add_http_vhost.domain }};
    server_name {{ task.nginx.add_http_vhost.domain }};

{% if task.nginx.add_http_vhost.ws_path %}
    location {{ task.nginx.add_http_vhost.ws_path }} {
        proxy_pass  {{ task.nginx.add_http_vhost.ws_proxy }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
{% endif %}

{% if not task.nginx.add_http_vhost.proxy %}
    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to index.html
        try_files $uri $uri/ {% if nginx_vhost_php == 'on' %}/index.php?$args {% else %}/index.html{% endif %};
    }
{% else %}
    location / {
        proxy_pass {{ task.nginx.add_http_vhost.proxy }};
        proxy_pass_header Set-Cookie;
    }
{% endif %}

{% if nginx_vhost_php == 'on' %}    
    # pass the PHP scripts to FastCGI server listening on {{ pool.listen }}
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini

        fastcgi_pass {{ pool.listen }};
        fastcgi_index index.php;
        include fastcgi_params;
    }
{% endif %}
}