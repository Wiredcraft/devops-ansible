{% set php = php | default({}) %}
{% set fpm = php.fpm | default({}) %}
{% set pool = fpm.pool | default({}) %}
{% set nginx_vhost_php = nginx_vhost_php | default('off') %}

server {
    listen   {{ nginx_vhost_port }};

    root /var/www/{{ nginx_vhost_domain }}/{{ nginx_vhost_webroot }};
    index {% if nginx_vhost_php == 'on' %}index.php{% endif %} index.html index.htm;

    # Make site accessible from http://localhost/
    # server_name {{ nginx_vhost_domain }};
    server_name {{ nginx_vhost_domain }};

{% if nginx_websocket_path %}
    location {{ nginx_websocket_path }} {
        proxy_pass  {{ nginx_websocket_proxy_pass }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
{% endif %}

{% if not nginx_vhost_proxy_pass %}
    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to index.html
        try_files $uri $uri/ {% if nginx_vhost_php == 'on' %}/index.php?$args {% else %}/index.html{% endif %};
    }
{% else %}
    location / {
        proxy_pass {{ nginx_vhost_proxy_pass }};
        proxy_pass_header Set-Cookie;
    }
{% endif %}

{% if nginx_vhost_php == 'on' %}    
    # pass the PHP scripts to FastCGI server listening on {{ pool.listen }}
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini

        fastcgi_pass {{ pool.listen }};
        fastcgi_index index.php;
        include fastcgi_params;
    }
{% endif %}
}