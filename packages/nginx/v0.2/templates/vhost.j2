{% set item = item | default({}) %}
{% set vhost_id = item.key | default('default') %}
{% set value = item.value | default({}) %}

{% set nginx = nginx | default({}) %}
{% set http = nginx.http | default({}) %}
{% set ssl = value.ssl | default(False) %}
{% set port = value.port | default(False) %}

{% set support = value.support | default([]) %}
{% set support_php = False %}
{% if 'php' in support %}{% set support_php = True %}{% endif %}


{# optional upstreams parameter #}
{% if value.upstreams is defined %}
{% for upstream in value.upstreams %}
upstream {{ upstream.name }} {
    {% for backend in upstream.backends %}
    server {{ backend }};
    {% endfor %}
}
{% endfor %}
{% endif %}

server {
    listen   {% if value.port is defined %}{{ value.port }}{% else %}{% if ssl %}443{% else %}80{% endif %}{% if ssl %} ssl{% endif %}{% endif %};
    root /var/www/{{ vhost_id }}/{{ value.webroot | default('') }};

    {% if ssl %}
    ssl_certificate {% if ssl.certificate %}{{ ssl.certificate }}{% else %}/etc/nginx/ssl/{{ vhost_id }}.pem{% endif %};
    ssl_certificate_key {% if ssl.private_key %}{{ ssl.private_key }}{% else %}/etc/nginx/ssl/{{ vhost_id }}.key{% endif %};
    {% endif %}

    {# Need better index management #}
    index {% if support_php %}index.php{% endif %} index.html index.htm;

    access_log {{ http.access_log | dirname }}/{{ vhost_id }}-access.log;
    error_log {{ http.error_log | dirname }}/{{ vhost_id }}-error.log;

    # Make site accessible from http://localhost/
    # server_name _;
    server_name {{ value.domain }} {% if value.aliases is defined %}{% if value.aliases is sequence %}{{ value.aliases | join(' ') }}{% else %}{{ value.aliases }}{% endif %}{% endif %};

{% for route in value.routes %}
    location {{ route.uri }} {
{% if route.type == 'proxy' %}
        proxy_pass {{ route.to }};
        proxy_pass_header Set-Cookie;
{% elif route.type == 'fastcgi' %}
        fastcgi_pass {{ route.to }};
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
        {# We may want to remove index.php #}
        fastcgi_index index.php; 
        include fastcgi_params;
{% elif route.type == 'websocket' %}
        proxy_pass {{ route.to }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
{% elif route.type == 'uwsgi' %}
        uwsgi_pass {{ route.to }};
        include uwsgi_params;
{% else %}
{# It covers anything else - including route.type == 'static' #}
        # First attempt to serve request as file, then
        # as directory, then fall back to index.html
        try_files $uri $uri/ {% if support_php %}/index.php?$args{% else %}/index.html{% endif %};

    {% if route.to is defined %}
        {# TODO: more checks to define if we want to use `alias` or `root` #}
        {% if route.static is defined %}{{ route.static }}{% else %}root{% endif %} {{ route.to }};
    {% endif %}
{% endif %}
{% if route.custom is defined %}
        {{ route.custom }}
{% endif %}
    }
{% endfor %}
}