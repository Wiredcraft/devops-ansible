---
- name: Ensure PHP is installed
  apt: 
    pkg={{ item }}
    state=present
  with_items:
    - php5-common
    - php5-cli
    - php5-dev
    - php5-curl
    - php5-mysql
    - php5-gd
    - php5-memcache
    - php5-fpm
    - php-pear

- name: Ensure PHP opscode
  apt: 
    pkg={{ item }}
    state=present
  with_items:
    - php-apc
  when:
    ansible_lsb.release | int <= 13 and ansible_lsb.codename != 'saucy'

- name: Ensure extra PHP extensions via APT
  apt:
    name={{ item }}
    state=present
  with_items:
    php.extensions
  notify:
    - Restart php5-fpm

- name: Ensure extra PHP extensions via PECL
  shell:
    creates=/root/.php_{{ item }}
    printf "\n" | pecl install {{ item }} | tee -a /root/.php_{{ item }} && echo 'extension = {{ item }}.so' > /etc/php.d/{{ item }}.ini
  with_items:
    php.pecl_extensions
  notify:
    - Restart php5-fpm

# Backup config
- name: Backup original config cli
  command: mv /etc/php5/cli/php.ini /etc/php5/cli/php.ini.orig 
           creates=/etc/php5/cli/php.ini.orig
           removes=/etc/php5/cli/php.ini

- name: Backup original config fpm
  command: mv /etc/php5/fpm/php.ini /etc/php5/fpm/php.ini.orig 
           creates=/etc/php5/fpm/php.ini.orig 
           removes=/etc/php5/fpm/php.ini

- name: Ensure log folders for php5-fpm
  file:
    state=directory
    path=/var/log/php-fpm
    owner=root
    group=root
    mode=755

- name: Ensure php.ini confguration
  template: 
    src=DEVOPS_PACKAGE/templates/php.ini.j2
    dest={{ item }}
    owner=root
    group=root
    mode=0644
  with_items:
    - /etc/php5/cli/php.ini
    - /etc/php5/fpm/php.ini
  notify:
    - Restart php5-fpm

- name: Backup original config of php5-fpm (step1)
  command: mv /etc/php5/fpm/php-fpm.conf /etc/php5/fpm/php-fpm.conf.orig 
           creates=/etc/php5/fpm/php-fpm.conf.orig 
           removes=/etc/php5/fpm/php-fpm.conf

- name: Backup original config of php5-fpm (step2)
  command: mv /etc/php5/fpm/pool.d/{{ php.fpm.pool.name }}.conf /etc/php5/fpm/pool.d/{{ php.fpm.pool.name }}.conf.orig
           creates=/etc/php5/fpm/pool.d/{{ php.fpm.pool.name }}.conf.orig
           removes=/etc/php5/fpm/pool.d/{{ php.fpm.pool.name }}.conf

- name: Ensure php5-fpm configuration is present
  template:
    src=DEVOPS_PACKAGE/templates/php-fpm.conf.j2
    dest=/etc/php5/fpm/php-fpm.conf
    owner=root
    group=root
    mode=0644
  notify:
    - Restart php5-fpm

- name: Ensure php5-fpm pool configuration is defined
  template:
    src=DEVOPS_PACKAGE/templates/php-fpm_pool.conf.j2
    dest=/etc/php5/fpm/pool.d/{{ php.fpm.pool.name }}.conf
    owner=root
    group=root
    mode=0644
  notify:
    - Restart php5-fpm

- name: Ensure php-apc confguration
  template: 
    src=DEVOPS_PACKAGE/templates/apc.ini.j2
    dest=/etc/php5/conf.d/apc.ini
    owner=root
    group=root
    mode=0644
  notify: 
    - Restart php5-fpm
  when:
    ansible_lsb.release | int <= 13 and ansible_lsb.codename != 'saucy'

- name: Ensure php composer is installed (when required)
  shell:
    creates=/usr/local/bin/composer
    mkdir -p /opt/php-composer && cd /opt/php-composer && curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer
  when:
    php.composer

