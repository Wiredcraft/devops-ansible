---
- name: Ensure Ruby and rbenv are installed (system)
  apt: 
    pkg={{ item }}
    state=present
  with_items:
    - ruby
    - rbenv

- name: Ensure global rbenv folders
  file:
    dest={{ item }}
    state=directory
    owner=root
    group=root
  with_items:
    - /opt/rbenv
    - /opt/rbenv/plugins
    - /opt/rbenv/shims
    - /opt/rbenv/versions

- name: Set rbenv PATH and shims
  lineinfile:
    dest=/etc/profile
    line='{{ item }}'
    state=present
  with_items:
    - 'export RBENV_ROOT=/opt/rbenv'
    - 'export PATH="$RBENV_ROOT/bin:$PATH"'
    - 'eval "$(rbenv init -)"'

- name: Add rbenv plugins
  git:
    repo=https://github.com/sstephenson/ruby-build.git
    dest=/opt/rbenv/plugins/ruby-build

- name: Install Ruby versions
  shell:
    bash -l -c 'rbenv install {{ item.key }}'
  with_dict:
    ruby.versions

- name: Ensure custom gem modules are installed
  gem:
    name={{ item }}
    state=present
    user_install=no
  with_items:
    ruby.gems
  ignore_errors: yes
