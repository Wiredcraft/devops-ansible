---
# file: initServer.yml

# This playbook is only meant to ensure the server get initialized
# and the devops user get created on the remote host.
#
# It should not be used after.
#
# It should be replaced from user / pass to SSH key

# Run initServer playbook with either of the following:
#   - if ssh user / password based
#       python bin/devops-playbook.py -i spaces/.../hosts initServer.yml \
#            -s -e newserver=__ip/host from inventory__ -u ubuntu -p ubuntu
#   - if ssh user / key based
#       python bin/devops-playbook.py -i spaces/.../hosts initServer.yml \
#            -s -e newserver=__ip/host from inventory__ -u ubuntu --private-key=PATH


- hosts: all
  vars_files:
    - config/global.yml
  tasks:
    - include: common/tasks/dependencies.yml
    - include: common/tasks/users.yml
    - include: common/tasks/packages.yml
    - include: common/tasks/monitoring.yml
    - include: services/apache/tasks.yml
      when_string: "'apache' in $group_names"
    - include: services/php/tasks.yml
      when_string: "'php' in $group_names"
    - include: services/php5-fpm/tasks.yml
      when_string: "'php5-fpm' in $group_names"
    - include: services/nginx/tasks.yml
      when_string: "'nginx' in $group_names"
    - include: services/mysql/tasks.yml
      when_string: "'mysql' in $group_names"
    - include: services/mongodb/tasks.yml
      when_string: "'mongodb' in $group_names"
    - include: services/memcached/tasks.yml
      when_string: "'memcached' in $group_names"
    - include: services/varnish/tasks.yml
      when_string: "'varnish' in $group_names"
  handlers:
    - include: common/handlers/monitoring.yml
    - include: services/$item/handlers.yml
      with_items:
        - apache
        - php
        - php5-fpm
        - nginx
        - mysql
        - mongodb
        - memcached
        - varnish
