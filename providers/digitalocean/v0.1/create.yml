---
- name: Ensure Digital Ocean SSH key
  action:
    module: digital_ocean
    client_id: ${client_id}
    api_key: ${api_key}
    command: ssh
    state: present
    name: ${space}
    ssh_pub_key: ${ssh_profile_key}
  delegate_to: 127.0.0.1
  register: do_key
- name: Ensure Digital Ocean server
  action:
    module: digital_ocean
    client_id: ${client_id}
    api_key: ${api_key}
    command: droplet
    size_id: ${size}
    image_id: ${image}
    region_id: ${region}
    ssh_key_ids: "${do_key.ssh_key.id}"
    name: ${name}
    state: present
    wait: yes
    wait_timeout: 600
  delegate_to: 127.0.0.1
  register: response
- name: Register new IP address for Digital Ocean server
  action:
    module: set_facts
    ansible_ssh_host: "${response.droplet.ip_address}"
  delegate_to: 127.0.0.1
- name: Wait for SSH to be reachable
  action:
    module: wait_for
    delay: 60
    host: "${response.droplet.ip_address}"
    port: 22
    timeout: 300
  delegate_to: 127.0.0.1
