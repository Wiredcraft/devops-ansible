---
- name: Ensure linode server
  action:
    module: linode
    api_key: ${api_key}
    plan: ${flavor}
    datacenter: ${region}
    distribution: ${image}
    ssh_pub_key: ${ssh_profile_key}
    name: ${name}
    state: present
    wait: yes
    wait_timeout: 500
  delegate_to: 127.0.0.1
  register: response
- name: Register new IP address for Linode server
  action:
    module: set_facts
    ansible_ssh_host: "${response.instance.ipv4}"
  delegate_to: 127.0.0.1
- name: Wait for SSH to be reachable
  action:
    module: wait_for
    delay: 60
    host: "${response.instance.ipv4}"
    port: 22
    timeout: 300
  delegate_to: 127.0.0.1