---
- name: Ensure Ec2 server
  action:
    module: ec2 
    ec2_access_key: ${ec2_access_key}
    ec2_secret_key: ${ec2_secret_key}
    group: ${securityGroup}
    image: ${image}
    instance_type: ${size}
    region: ${region}
    key_name: ${keyName}
    instance_tags: '{"name": "${inventory_hostname}"}'
    wait: yes
    wait_timeout: 500
  delegate_to: 127.0.0.1
  register: response
- name: Register new IP address for ec2 server
  action:
    module: set_facts
    ansible_ssh_host: "${response.instances[0].public_ip}"
  delegate_to: 127.0.0.1
- name: Wait for SSH to be reachable
  action:
    module: wait_for
    delay: 60
    host: "${response.instances[0].public_ip}"
    port: 22
    timeout: 300
  delegate_to: 127.0.0.1